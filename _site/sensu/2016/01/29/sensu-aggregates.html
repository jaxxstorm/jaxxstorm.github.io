<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Sensu Aggregates | lbr.</title>

<meta name="description" content="Engineering, DevOps & Cloud Computing
">
<meta name="keywords" content="">
<link rel="canonical" href="/sensu/2016/01/29/sensu-aggregates.html">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34865189-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34865189-1');
</script>


<!--Feature assets-->
<!--Bootstrap JS-->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<!--Font Awesome-->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

<!--Highlight.js-->
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!--Main assets-->
<link rel="icon" type="image/jpeg" href="/favicon.png"/>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
<div class="wrapper">
<header class="header">
<div class="navigation">

<a href="/" class="logo">lbr.</a>

<ul class="menu">
<li class="menu__entry"><a href="/">about</a></li>
<li class="menu__entry"><a href="/projects">projects</a></li>
<li class="menu__entry"><a href="/blog">blog</a></li>
</ul>
</div>
<ul class="social-links">

<a href="mailto:/contact@leebriggs.co.uk" class="social-links__entry" target="_blank">
<i class="fas fa-envelope-square"></i>
</a>


<a href="https://github.com//jaxxstorm" class="social-links__entry" target="_blank">
<i class="fab fa-github"></i>
</a>


<a href="https://linkedin.com/in//briggsl" class="social-links__entry" target="_blank">
<i class="fab fa-linkedin-in"></i>
</a>

</ul>
</header>

<br>
<br>
<h1 class="post-title">
    <div class="post-title__text">Sensu Aggregates</div>
</h1>
<p class="post-title__subtitle">Published Jan 29, 2016  by <a href="https://leebriggs.co.uk/">Lee Briggs<a><br />


<hr>
<br>
<p>Sensu has really evolved into a first class monitoring tool, and the main reason for this is in part due to its flexibility and being able to solve monitoring problems in a way that suits you. Up until this point at $employer, we’ve mainly made use of sensu checks that run locally on the client they’re registered to (referred to from here as “standalone mode”) and this accounts for probably 85% of the monitoring checks that we run. It’s the usually mix of disk space and “is this service running” and of course, the right place to run these checks is directly on the client.</p>

<p>As previously mentioned, we use Puppet to distribute these checks, and the <a href="https://github.com/sensu/sensu-puppet.git">puppet-sensu module</a> makes this easy, you simply define a check using the sensu::check defined type:</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet">  <span class="p">::</span><span class="n">sensu::check</span> <span class="p">{</span> <span class="s1">'check_something'</span><span class="p">:</span>
    <span class="py">ensure</span>     <span class="p">=&gt;</span> <span class="s1">'present'</span><span class="p">,</span>
    <span class="py">command</span>    <span class="p">=&gt;</span> <span class="s1">'/my/command.rb'</span><span class="p">,</span>
    <span class="py">standalone</span> <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">}</span></code></pre></figure>

<p>A big driver for making this easy has been yelp’s <a href="https://github.com/Yelp/puppet-monitoring_check">monitoring_check module</a> puppet module, which is a defined type wrapper around the ::sensu::check type which sets up some sane defaults for you and incorporates some things like sending alerts to different teams, assuming you make use of their <a href="https://github.com/Yelp/sensu_handlers">sensu handlers</a> as well.</p>

<p>Yelp mainly uses standalone checks, but to solve the problem of monitoring remote more complex services like clusters and remote services, they’ve taken an interesting approach. They’ve written some custom monitoring checks with actually dip into the redis datastore for sensu to collect aggregates for each check and then return the result, and they’ve also written a monitoring check which will check server side components and manually lock between sensu servers. You can see their examples in their <a href="https://github.com/Yelp/puppet-monitoring_check/blob/master/files/fleet_check.rb">fleet_check</a>, <a href="https://github.com/Yelp/puppet-monitoring_check/blob/master/files/check-cluster.rb">check-cluster</a> and the <a href="https://github.com/Yelp/puppet-monitoring_check/blob/master/files/check_server_side.rb">check_server_side</a> checks.</p>

<p>I did something similar to Yelp with my defined types for standalone checks, but making use of their server side, aggregation and fleet checks wasn’t really going to cut it for me because their sensu setup makes a series of assumptions about how to set up your sensu infrastructure, and my infrastructure isn’t like theirs in many ways. I went a different route to solve the aggregate and server side checks which uses sensu’s built in capabilities to execute the checks, and I’ve never really seen a write up on how to do these things, so I’m going to write them in a couple of blog posts. First, we’ll start off with an aggregate check.</p>

<h2 id="defining-a-server-side-check">Defining a server side check</h2>

<p>The first thing you have to do is simple, set up a check on the server side of sensu. The way this works is that instead of the check definition residing on the client, it resides on the server, and the sensu client <em>subscribes</em> to the checks. Let’s assume here that we have a fleet of web servers that we want to check - first, we’d need to assign a subscription to the sensu client:</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet">  <span class="k">node</span> <span class="s1">'sensu-client.example.com'</span> <span class="p">{</span>
    <span class="k">class</span> <span class="p">{</span> <span class="s1">'sensu'</span><span class="p">:</span>
      <span class="py">subscriptions</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="s1">'webservers'</span><span class="p">,</span> <span class="s1">'base'</span> <span class="p">],</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></figure>

<p>This translate to JSON for the client conf like so:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">client</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">webserver</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">address</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">10.0.0.1</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">subscriptions</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">base</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">webservers</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">bind</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">127.0.0.1</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">port</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">3030</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">safe_mode</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>One we’ve set the subscription on the client, we can create a check on the server that executes on the client using the subscription. On your server, create a check like so:</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="k">node</span> <span class="s1">'sensu-server.example.com'</span> <span class="p">{</span>
  <span class="p">::</span><span class="n">sensu::check</span> <span class="p">{</span> <span class="s1">'check-webserver'</span><span class="p">:</span>
    <span class="py">ensure</span>      <span class="p">=&gt;</span> <span class="s1">'present'</span><span class="p">,</span>
    <span class="py">command</span>     <span class="p">=&gt;</span> <span class="s1">'/etc/sensu/plugins/check-webserver.rb'</span><span class="p">,</span>
    <span class="py">standalone</span>  <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="py">subscribers</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="s1">'webservers'</span> <span class="p">],</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Now, when you restart the sensu client and server, the check definition will appear on the sensu server as a normal check but will execute on the client.</p>

<p>On its own, this doesn’t give you must more benefit than just a standalone check residing on a client, but it really starts to become useful when you want to check multiple different hosts for the same condition.</p>

<p>Say for example we have 30 web servers, and one being down isn’t necessarily a problem because we have a great load balancer that will kill the connections. However, if 50% of the web servers are down you’ll have a problem, because your ability to deal with traffic is compromised. If you’ve defined the check server side, you can make use of sensu’s <a href="https://sensuapp.org/docs/latest/api-aggregates">aggregate feature</a> to help you here.</p>

<h2 id="defining-an-aggregate">Defining an aggregate</h2>

<p>Turning a check into an aggregate is easy, assuming you’ve defined the check on the server side. Unfortunately, aggregates <em>only</em> work on the server side. The reason for this is because when you define a server side check, a sensu server will send out a check request to all clients at the same time, with a timestamp defined when the request was sent. When the server gets all the results back, they all have the same timestamp and so you can aggregate them. With a client side check, the timestamps will all be completely different so aggregating isn’t really an option.</p>

<p>To define the aggregate, just set up the aggregate parameter - with the puppet module:</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="k">node</span> <span class="s1">'sensu-server.example.com'</span> <span class="p">{</span>
  <span class="p">::</span><span class="n">sensu::check</span> <span class="p">{</span> <span class="s1">'check-webserver'</span><span class="p">:</span>
    <span class="py">ensure</span>      <span class="p">=&gt;</span> <span class="s1">'present'</span><span class="p">,</span>
    <span class="py">command</span>     <span class="p">=&gt;</span> <span class="s1">'/etc/sensu/plugins/check-webserver.rb'</span><span class="p">,</span>
    <span class="py">standalone</span>  <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="py">subscribers</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="s1">'webservers'</span> <span class="p">],</span>
    <span class="py">aggregate</span>   <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="py">handle</span>      <span class="p">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>It’s worth noting here that I’ve also set the parameter handle =&gt; false, the reason for this is because I don’t care if a single web server fails, I just want to know about the health of the web servers overall. The JSON looks like so:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">checks</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">check-webserver</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">command</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/etc/sensu/plugins/check-webserver.rb</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">subscribers</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">webservers</span><span class="dl">"</span>
      <span class="p">],</span>
      <span class="dl">"</span><span class="s2">standalone</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">aggregate</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">handle</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Once this starts to run, you’ll be able to see the aggregate by querying the sensu API:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">-s</span> <span class="nt">-u</span> admin <span class="nt">-p</span> http://sensu-server.example.com:4567/aggregates | jq <span class="nb">.</span>
Enter host password <span class="k">for </span>user <span class="s1">'admin'</span>:
<span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">"check"</span>: <span class="s2">"check-webserver"</span>,
    <span class="s2">"issued"</span>: <span class="o">[</span>
      1454081158,
      1454080558,
      1454079958,
      1454079358,
      1454078758,
      1454078158,
      1454077557,
      1454076957,
      1454076357,
      1454075757,
      1454075157,
      1454074557,
      1454073957,
      1454073357,
      1454072757,
      1454072157,
      1454071557,
      1454070957,
      1454070357,
      1454069757
    <span class="o">]</span>
  <span class="o">}</span>,</code></pre></figure>

<p>and if you look at a single aggregate, you’ll start to see how useful they are!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">-s</span> <span class="nt">-u</span> admin <span class="nt">-p</span> http://sensu-server.example.com:4567/aggregates/check-webserver/1454081758 | jq <span class="nb">.</span>
Enter host password <span class="k">for </span>user <span class="s1">'admin'</span>:
<span class="o">{</span>
  <span class="s2">"ok"</span>: 30,
  <span class="s2">"warning"</span>: 1,
  <span class="s2">"critical"</span>: 1,
  <span class="s2">"unknown"</span>: 0,
  <span class="s2">"total"</span>: 32
<span class="o">}</span></code></pre></figure>

<p>Now we’re in a position to know how many of our webservers are responding easily. We have all the check results aggregated, and we can query the API easily to see the status. The final step is to alert on this aggregate.</p>

<h2 id="alerting-on-an-aggregate-check">Alerting on an aggregate check</h2>

<p>You can write any number of custom checks here to make this work, but I chose to make use of the available <a href="https://github.com/sensu-plugins/sensu-plugins-sensu/blob/master/bin/check-aggregate.rb">check-aggregate.rb</a> in the community plugins repo. You invoke it like so:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/etc/sensu/plugins/check-aggregate.rb <span class="nt">-a</span> http://sensu-server.example.com:4567 <span class="nt">-c</span> check-webserver <span class="nt">-u</span> admin <span class="nt">-p</span> &lt;password&gt; <span class="nt">-C</span> 10 <span class="nt">-M</span> <span class="s2">"10% of your webservers are down!"</span></code></pre></figure>

<p>This is hopefully pretty self explanatory, but basically, you need to pass the sensu API details, as well as a threshold under which your aggregate will drop and a message the check will output if the check fails.</p>

<p>To have this run, you can define it as a standalone check:</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="k">node</span> <span class="s1">'sensu-server.example.com'</span> <span class="p">{</span>
  <span class="p">::</span><span class="n">sensu::check</span> <span class="p">{</span> <span class="s1">'check-webserver-cluster'</span><span class="p">:</span>
    <span class="py">ensure</span>      <span class="p">=&gt;</span> <span class="s1">'present'</span><span class="p">,</span>
    <span class="py">command</span>     <span class="p">=&gt;</span> <span class="s1">'/etc/sensu/plugins/check-aggregate.rb -a http://sensu-server.example.com:4567 -c check-webserver -u admin -p &lt;password&gt; -C 10 -M "10% of your webservers are down!"'</span><span class="p">,</span>
    <span class="py">standalone</span>  <span class="p">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="py">source</span>      <span class="p">=&gt;</span> <span class="s2">"production_webservers"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Notice I make use of the “source” parameter so that sensu will create a <a href="https://sensuapp.org/docs/latest/clients#jit-clients">JIT client</a> rather than have it create an event for our monitoring server.</p>

<p>This will work, and you’ll have monitoring of your aggregate working - yay!</p>

<p>One thing to note though, is that this check will be running on your monitoring server all the time, and this might not be desirable. In the next post I’ll talk about another use of sensu-server side checks and how we can use them to schedule the check to run on only one of the hosts in a subscription, to make a check highly available across your fleet!</p>

<br>

<div id="disqus_thread"></div>
<script>


var disqus_config = function () {
this.page.url = 'http://localhost:4000/assets/style.css';
this.page.identifier = '/sensu/2016/01/29/sensu-aggregates.html'; 
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

<br>
<div class="about">
<div class="about__devider">*****</div>
<div class="about__text">
<br>
&#169 2021, Lee Briggs | <a href="https://github.com/ritijjain/pudhina-fresh">Pudhina Fresh</a> theme for Jekyll.
</div>
</div>

</div>
</body>
</html>