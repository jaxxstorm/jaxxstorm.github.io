<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Using sensu redaction | lbr.</title>

<meta name="description" content="Engineering, DevOps & Cloud Computing
">
<meta name="keywords" content="">
<link rel="canonical" href="/sensu/2016/01/27/using-sensu-redaction.html">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34865189-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34865189-1');
</script>


<!--Feature assets-->
<!--Bootstrap JS-->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<!--Font Awesome-->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

<!--Highlight.js-->
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!--Main assets-->
<link rel="icon" type="image/jpeg" href="/favicon.png"/>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
<div class="wrapper">
<header class="header">
<div class="navigation">

<a href="/" class="logo">lbr.</a>

<ul class="menu">
<li class="menu__entry"><a href="/">about</a></li>
<li class="menu__entry"><a href="/projects">projects</a></li>
<li class="menu__entry"><a href="/blog">blog</a></li>
</ul>
</div>
<ul class="social-links">

<a href="mailto:/contact@leebriggs.co.uk" class="social-links__entry" target="_blank">
<i class="fas fa-envelope-square"></i>
</a>


<a href="https://github.com//jaxxstorm" class="social-links__entry" target="_blank">
<i class="fab fa-github"></i>
</a>


<a href="https://linkedin.com/in//briggsl" class="social-links__entry" target="_blank">
<i class="fab fa-linkedin-in"></i>
</a>

</ul>
</header>

<br>
<br>
<h1 class="post-title">
    <div class="post-title__text">Using sensu redaction</div>
</h1>
<p class="post-title__subtitle">Published Jan 27, 2016  by <a href="https://leebriggs.co.uk/">Lee Briggs<a><br />


<hr>
<br>
<p>Sensu has a lot of cool features, but some of them are rarely used because either the documentation isn’t massively clear, or people deem it a “bit hard”. One of these cool features is redaction of passwords. You may have seen many a sensu check in the uchiwa dashboard with the password hanging out on the command line call used to run the sensu plugin. This isn’t much fun, especially when you consider that many remote services require some kind of API key or password to check their health.</p>

<p>Well, fortunately, this is pretty easy to rectify with a few tweaks.</p>

<p>It’s worth mentioning at this point that I use puppet to deploy my sensu clients and checks, so this will assume you’re doing the same. I’ll try include pure JSON examples where possible so that those of you that use other config management tools can follow along.</p>

<h3 id="lets-redact-some-shit">Let’s redact some shit</h3>

<p>A fundamental thing to understand with redaction is that the redaction key you want to use is actually set inside the client config, not inside the check. You have to define on the client config:</p>

<ul>
  <li>What things you want to redact</li>
  <li>What the password for $service will be</li>
</ul>

<h3 id="redacting-fields">Redacting fields</h3>

<p>Determining what to redact is fairly easy; just include a “redact” key in the client’s json.</p>

<p>If you use Puppet, you can do this really easily using the sensu-puppet module using sensu::redact (note, at time of writing this hasn’t been merged, but hoping it will soon!)</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="k">class</span> <span class="p">{</span> <span class="s1">'sensu'</span><span class="p">:</span>
  <span class="py">redact</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="s1">'password'</span><span class="p">,</span> <span class="s1">'pass'</span><span class="p">,</span> <span class="s1">'api_key'</span> <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>Or, if like me, you use hiera, setting the following in your common.yaml</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">sensu::redact</span>
  <span class="s">- "password"</span>
  <span class="s">- "pass"</span>
  <span class="s">- "api_key"</span></code></pre></figure>

<p>This will result in the following JSON in your client config:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">client</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">client</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">address</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">192.168.4.21</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">subscriptions</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">base</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">safe_mode</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">keepalive</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">handler</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">opsgenie</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">thresholds</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">warning</span><span class="dl">"</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">critical</span><span class="dl">"</span><span class="p">:</span> <span class="mi">90</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">redact</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">api_key</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">pass</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">socket</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">bind</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">127.0.0.1</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">port</span><span class="dl">"</span><span class="p">:</span> <span class="mi">3030</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="setting-a-service-password">Setting a service password</h3>

<p>Depending on how you do your configuration management, you may find this easy or hard, but the next step is to set a password inside the client for the service you’ll monitor. I make heavy use of the <a href="http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-2/">roles and profiles</a> pattern with my Puppet config, so this is a simple as setting a password inside a particular client role. Normally I use hiera to do this, and I make use of sensu-puppet’s client_custom options to set up these passwords. It looks a little bit like this:</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="k">class</span> <span class="p">{</span> <span class="s1">'sensu'</span><span class="p">:</span>
  <span class="py">redact</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="s1">'password'</span><span class="p">,</span> <span class="s1">'pass'</span><span class="p">,</span> <span class="s1">'api_key'</span> <span class="p">]</span>
  <span class="py">client_custom</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="py">github</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="py">password</span> <span class="p">=&gt;</span> <span class="s1">'correct-horse-battery-staple'</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">}</span></code></pre></figure>

<p>or with hiera:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">sensu::redact</span>
  <span class="s">- "password"</span>
  <span class="s">- "pass"</span>
  <span class="s">- "api_key"</span>
<span class="s">sensu::client_custom:</span>
  <span class="s">nexus</span><span class="pi">:</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">correct-horse-battery-staple"</span></code></pre></figure>

<p>The resulting JSON, for those that use different config management systems, looks like this:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">client</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">client</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">address</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">192.168.4.21</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">subscriptions</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">base</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">safe_mode</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">keepalive</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">handler</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">opsgenie</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">thresholds</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">warning</span><span class="dl">"</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">critical</span><span class="dl">"</span><span class="p">:</span> <span class="mi">90</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">redact</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">api_key</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">pass</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">socket</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">bind</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">127.0.0.1</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">port</span><span class="dl">"</span><span class="p">:</span> <span class="mi">3030</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">github</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">correct-horse-battery-staple</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Note I’ve set up the service name (github) and then made a subkey of “password”. Because we set the “password” field to be redacted, we need to use a subkey, so that only the password is redacted.</p>

<p>When you look in your dashboard or in your logfiles, you’ll now see something like this:</p>

<p><img src="http://i.imgur.com/K4noGoN.png" alt="Sensu Redaction" /></p>

<h3 id="using-the-password">Using the password</h3>

<p>Now, when I define the sensu check on the clients (with the same role, so it has access to the password, obviously) we use <a href="https://sensuapp.org/docs/0.16/checks#check-command-token-substitution">check command token substituion</a> to make use of this field. This will essentially grab the correct value from the client config (which you defined earlier) and use that instead of the substitution.</p>

<figure class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="n">sensu::check</span><span class="p">{</span> <span class="s1">'check_password_test'</span><span class="p">:</span>
  <span class="py">command</span>      <span class="p">=&gt;</span> <span class="s1">'/usr/local/bin/check_password_test --password :::github.password::: '</span><span class="p">,</span>
<span class="p">}</span></code></pre></figure>

<p>of course, with JSON, just make sure the command field uses the substitution:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">checks</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">check_password_test</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">standalone</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">command</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/usr/local/bin/check_password_test --password :::github.password:::</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Hopefully this clears up some questions about how exactly sensu redaction is used in the wild, as it’s fairly easy to implement and yet not a lot of people seem to do it!</p>

<br>

<div id="disqus_thread"></div>
<script>


var disqus_config = function () {
this.page.url = 'http://localhost:4000/assets/style.css';
this.page.identifier = '/sensu/2016/01/27/using-sensu-redaction.html'; 
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

<br>
<div class="about">
<div class="about__devider">*****</div>
<div class="about__text">
<br>
&#169 2021, Lee Briggs | <a href="https://github.com/ritijjain/pudhina-fresh">Pudhina Fresh</a> theme for Jekyll.
</div>
</div>

</div>
</body>
</html>