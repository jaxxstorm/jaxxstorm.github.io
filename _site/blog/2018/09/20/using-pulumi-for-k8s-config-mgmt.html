<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Using Pulumi for Kubernetes configuration management | lbr.</title>

<meta name="description" content="Engineering, DevOps & Cloud Computing
">
<meta name="keywords" content="pulumi, kubernetes, configuration mgmt">
<link rel="canonical" href="/blog/2018/09/20/using-pulumi-for-k8s-config-mgmt.html">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34865189-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34865189-1');
</script>


<!--Feature assets-->
<!--Bootstrap JS-->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<!--Font Awesome-->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

<!--Highlight.js-->
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!--Main assets-->
<link rel="icon" type="image/jpeg" href="/favicon.png"/>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
<div class="wrapper">
<header class="header">
<div class="navigation">

<a href="/" class="logo">lbr.</a>

<ul class="menu">
<li class="menu__entry"><a href="/">about</a></li>
<li class="menu__entry"><a href="/projects">projects</a></li>
<li class="menu__entry"><a href="/blog">blog</a></li>
</ul>
</div>
<ul class="social-links">

<a href="mailto:/contact@leebriggs.co.uk" class="social-links__entry" target="_blank">
<i class="fas fa-envelope-square"></i>
</a>


<a href="https://github.com//jaxxstorm" class="social-links__entry" target="_blank">
<i class="fab fa-github"></i>
</a>


<a href="https://linkedin.com/in//briggsl" class="social-links__entry" target="_blank">
<i class="fab fa-linkedin-in"></i>
</a>

</ul>
</header>

<br>
<br>
<h1 class="post-title">
    <div class="post-title__text">Using Pulumi for Kubernetes configuration management</div>
</h1>
<p class="post-title__subtitle">Published Sep 20, 2018  by <a href="https://leebriggs.co.uk/">Lee Briggs<a><br />


    <span class="badge badge-info">#pulumi</span>

    <span class="badge badge-info">#kubernetes</span>

    <span class="badge badge-info">#configuration mgmt</span>

<hr>
<br>
<p>A few months back, I wrote an article which got a bit of interest around the issues configuring and maintaining multiple clusters, and keeping the components required to make them useful in sync. Essentially, the missing piece of the puzzle was that there was no <em>cluster aware</em> configuration management tool.</p>

<p>Internally, we created an excellent tool at <code class="language-plaintext highlighter-rouge">$work</code> to solve this using <a href="http://jsonnet.org/">jsonnet</a>, which has been very nice because it’s meant we get to use actual code to solve this problem. The only issue is that the code we have to write in is relatively niche!</p>

<p>When <a href="https://pulumi.io/">Pulumi</a> was announced back in June, I got very excited. After seeing the that Pulumi <a href="https://blog.pulumi.com/cloud-native-infrastructure-with-kubernetes-and-pulumi">now supports Kubernetes natively</a>, I wanted to dig in and see if it would help with the configuration management problem.</p>

<h1 id="introductory-concepts">Introductory Concepts</h1>

<p>Before I speak about the Kubernete–specific components, I want to do a brief introduction into what Pulumi actually is.</p>

<p>Pulumi is a tool which allows you to create cloud resources using real programming languages. In my personal opinion, it is essentially <a href="https://www.terraform.io/">terraform</a> with full programming languages on top of it, instead of <a href="https://github.com/hashicorp/hcl">HCL</a>.</p>

<p>Having real programming languages means you can make the resources you configure as flexible or complex as you like. Each <em>provider</em> (AWS, GCE, Azure and Kubernetes) has support for different languages. Currently, the AWS provider has support for Go, Python and Javascript/Typescript whereas the Kubernetes provider has support only for Javascript/Typescript at the moment.</p>

<h2 id="stacks">Stacks</h2>

<p>Pulumi uses the concept of a <a href="https://pulumi.io/reference/stack.html">stack</a> to segregate things like environments or feature branches. For example, you may have a stack for your development environment and one for your production environment.</p>

<p>These stacks <a href="https://pulumi.io/reference/state.html">store their state</a> in a similar fashion to terraform. You can either store the state in:</p>

<ul>
  <li>The public pulumi web backend</li>
  <li>locally on the filesystem</li>
</ul>

<p>There is also an enterprise hosted stack storage provider. Hopefully it’ll be possible to have an open source stack storage some time soon.</p>

<h2 id="components">Components</h2>

<p><a href="https://pulumi.io/reference/component-tutorial.html">Components</a> allow you to share reusable modules, in a similar manner to terraform modules. This means you can write reusable code and create boilerplate for regularly reused resources, like S3 buckets.</p>

<h2 id="configuration">Configuration</h2>

<p>Finally, there’s <a href="https://pulumi.io/reference/config.html">configuration ability</a> within Pulumi stacks and components. What this allows you to do is differentiation configuration in the code depending on the stack you’re using. You specify these configuration values like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pulumi config set name my_name
</code></pre></div></div>

<p>And then you can reference that within your code!</p>

<h1 id="kubernetes-configuration-management">Kubernetes Configuration Management</h1>

<p>If you remember back to my <a href="https://leebriggs.co.uk/blog/2018/05/08/kubernetes-config-mgmt.html">previous post</a>, the issue I was trying to solve was being able to install components that every cluster needs (as an example, an ingress controller) to all the clusters but with often differing configuration values (for example, the path to a certificate arn in AWS ACM). Helm helps with this in that it allows you to specify values when installing, but then managing, maintaining and storing those values for each cluster becomes difficult, and applying them also becomes hard.</p>

<h2 id="pulumi">Pulumi</h2>

<p>There are two main reasons Pulumi is helping here. Firstly, it allows you to differentiate kubernetes clusters within stacks. As an example, let’s say I have two clusters - one in GKE and one in Digital Ocean. Here you can see them in my kubernetes contexts:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectx
digitalocean
lbrlabs@gcloud</code></pre></figure>

<p>I can initiate a <em>stack</em> for each of these clusters with Pulumi, like so:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># create a Pulumi.yml first!</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; Pulumi.yml
name: nginx
runtime: nodejs
description: An example stack for Pulumi
</span><span class="no">EOF
</span>pulumi stack init gcloud
pulumi config <span class="nb">set </span>kubernetes:context lbrlabs@gcloud</code></pre></figure>

<p>Obviously, you’d repeat the stack and config steps for each cluster!</p>

<p>Now, if I want to actually deploy something to the stack, I need to write some code. If you’re not familiar with typescript (I wasn’t, until I wrote this) you’ll need to generate a <code class="language-plaintext highlighter-rouge">package.json</code> and a <code class="language-plaintext highlighter-rouge">tsconfig.json</code></p>

<p>Fortunately, Pulumi automates this for us!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pulumi new <span class="nt">--generate-only</span> <span class="nt">--force</span></code></pre></figure>

<p>If you’re doing a Kubernetes thing, you’ll need to select kubernetes-typescript from the template prompt.</p>

<p>Now we’re ready to finally write some code!</p>

<h3 id="deploying-a-standard-kubernetes-resource">Deploying a standard Kubernetes resource</h3>

<p>When you ran <code class="language-plaintext highlighter-rouge">pulumi new</code>, you got an <code class="language-plaintext highlighter-rouge">index.ts</code> file. In it, it imports pulumi:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">k8s</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@pulumi/kubernetes</span><span class="dl">"</span><span class="p">;</span></code></pre></figure>

<p>You can now write standard typescript and generate Kubernetes resources. Here’s an example nginx pod as a deployment:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">k8s</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@pulumi/kubernetes</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// set some defaults</span>
<span class="kd">const</span> <span class="nx">defaults</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nginx</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">namespace</span><span class="p">:</span> <span class="dl">"</span><span class="s2">default</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">labels</span><span class="p">:</span> <span class="p">{</span><span class="na">app</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nginx</span><span class="dl">"</span><span class="p">},</span>
  <span class="na">serviceSelector</span><span class="p">:</span> <span class="p">{</span><span class="na">app</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nginx</span><span class="dl">"</span><span class="p">},</span>
<span class="p">};</span>

<span class="c1">// create the deployment</span>
<span class="kd">const</span> <span class="nx">apacheDeployment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">(</span>
  <span class="nx">defaults</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">namespace</span><span class="p">:</span> <span class="nx">defaults</span><span class="p">.</span><span class="k">namespace</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="na">labels</span><span class="p">:</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">labels</span>
    <span class="p">},</span>
    <span class="na">spec</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">replicas</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">selector</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">matchLabels</span><span class="p">:</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">labels</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="na">template</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">labels</span><span class="p">:</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">labels</span>
        <span class="p">},</span>
        <span class="na">spec</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">containers</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="na">name</span><span class="p">:</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
              <span class="na">image</span><span class="p">:</span> <span class="s2">`nginx:1.7.9`</span><span class="p">,</span>
              <span class="na">ports</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">,</span>
                  <span class="na">containerPort</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https</span><span class="dl">"</span><span class="p">,</span>
                  <span class="na">containerPort</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
                <span class="p">}</span>
              <span class="p">],</span>
            <span class="p">}</span>
          <span class="p">],</span>
        <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">}</span>
  <span class="p">});</span></code></pre></figure>

<p>Here you can already see the power that writing true code has - defining a constant for defaults and allowing us to use those values in the declaration of the resource means less duplicated code and less copy/pasting.</p>

<p>The real power comes when using the config options we set earlier. Assuming we have two Pulumi stacks, <code class="language-plaintext highlighter-rouge">gcloud</code> and <code class="language-plaintext highlighter-rouge">digitalocean</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pulumi stack <span class="nb">ls
</span>NAME                                             LAST UPDATE              RESOURCE COUNT
digitalocean<span class="k">*</span>                                    n/a                      n/a
gcloud                                           n/a                      n/a</code></pre></figure>

<p>and these stacks are mapped to different contexts, like so:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pulumi config <span class="nt">-s</span> gcloud
KEY                                              VALUE
kubernetes:context                               lbrlabs@gcloud
pulumi config <span class="nt">-s</span> digitalocean
KEY                                              VALUE
kubernetes:context                               digitalocean</code></pre></figure>

<p>you can now also set different configuration options and keys which can be used in the code.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pulumi config <span class="nb">set </span>imageTag 1.14-alpine <span class="nt">-s</span> gcloud
pulumi config <span class="nb">set </span>imageTag 1.15-alpine <span class="nt">-s</span> digitalocean</code></pre></figure>

<p>This will write out these values into a <code class="language-plaintext highlighter-rouge">Pulumi.&lt;stackname&gt;.yaml</code> in the project directory:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cat </span>Pulumi.digitalocean.yaml
config:
  kubernetes:context: digitalocean
  pulumi-example:imageTag: 1.15-alpine</code></pre></figure>

<p>and we can now use this in the code very easily:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">Config</span><span class="p">(</span><span class="dl">"</span><span class="s2">pulumi-example</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// use the name field in the Pulumi.yaml here</span>
<span class="kd">let</span> <span class="nx">imageTag</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">imageTag</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">// this is part of the pod spec, you'll need the rest of the code too!</span>
<span class="nl">image</span><span class="p">:</span> <span class="s2">`nginx:</span><span class="p">${</span><span class="nx">imageTag</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span></code></pre></figure>

<p>Now, use Pulumi from your project’s root to see what would happen:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pulumi up <span class="nt">-s</span> gcloud
Previewing update of stack <span class="s1">'gcloud'</span>
Previewing changes:

     Type                           Name                   Plan       Info
 +   pulumi:pulumi:Stack            pulumi-example-gcloud  create
 +   └─ kubernetes:apps:Deployment  nginx                  create

info: 2 changes previewed:
    + 2 resources to create

Do you want to perform this update? <span class="nb">yes
</span>Updating stack <span class="s1">'gcloud'</span>
Performing changes:

     Type                           Name                   Status      Info
 +   pulumi:pulumi:Stack            pulumi-example-gcloud  created
 +   └─ kubernetes:apps:Deployment  nginx                  created

info: 2 changes performed:
    + 2 resources created
Update duration: 17.704161467s

Permalink: file:///Users/Lee/.pulumi/stacks/gcloud.json</code></pre></figure>

<p>Obviously you can specify whicever stack you need as required!</p>

<p>Let’s verify what happened…</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectx digitalocean <span class="c"># switch to DO context</span>
kubectl get deployment <span class="nt">-o</span> wide
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES              SELECTOR
nginx     1         1         1            1           1m        nginx        nginx:1.15-alpine   <span class="nv">app</span><span class="o">=</span>nginx

kubectx lbrlabs@gcloud <span class="c"># let's look now at gcloud context</span>
Switched to context <span class="s2">"lbrlabs@gcloud"</span><span class="nb">.</span>
k get deployment <span class="nt">-o</span> wide
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES              SELECTOR
nginx     1         1         1            1           3m        nginx        nginx:1.14-alpine   <span class="nv">app</span><span class="o">=</span>nginx</code></pre></figure>

<p>Okay, so as you can see here, I’ve deployed an nginx deployment to two different clusters, with two different images with very little effort and energy. Awesome!</p>

<h2 id="going-further---helm">Going further - Helm</h2>

<p>What makes this <em>really really</em> awesome is that Pulumi already supports Helm charts!</p>

<p>In my previous post, I made the comment that Helm has lots of community supported charts which have done a whole load of configuration for you. However, Helm suffers from 2 main problems (in my humble opinion)</p>

<ul>
  <li>Templating yaml with Go templates is extremely painful when doing complex tasks</li>
  <li>The helm chart community can be slow to merge pull requests. This means if you find an issue with a chart, you unfortunately have to fork it, and host it yourself.</li>
</ul>

<p>Pulumi really helps and solves this problem. Let me show you how!</p>

<p>First, let’s create a Pulumi component using a helm chart:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">k8s</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@pulumi/kubernetes</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">helm</span><span class="p">.</span><span class="nx">v2</span><span class="p">.</span><span class="nx">Chart</span><span class="p">(</span><span class="dl">"</span><span class="s2">redis</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">repo</span><span class="p">:</span> <span class="dl">"</span><span class="s2">stable</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">chart</span><span class="p">:</span> <span class="dl">"</span><span class="s2">redis</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">version</span><span class="p">:</span> <span class="dl">"</span><span class="s2">3.10.0</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">values</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">usePassword</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">rbac</span><span class="p">:</span> <span class="p">{</span> <span class="na">create</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>And now preview what would happen on this stack:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pulumi preview <span class="nt">-s</span> digitalocean
Previewing update of stack <span class="s1">'digitalocean'</span>
Previewing changes:

     Type                                                    Name                              Plan       Info
 +   pulumi:pulumi:Stack                                     pulumi-helm-example-digitalocean  create
 +   └─ kubernetes:helm.sh:Chart                             redis                             create
 +      ├─ kubernetes:core:Secret                            redis                             create
 +      ├─ kubernetes:rbac.authorization.k8s.io:RoleBinding  redis                             create
 +      ├─ kubernetes:core:Service                           redis-slave                       create
 +      ├─ kubernetes:core:Service                           redis-master                      create
 +      ├─ kubernetes:core:ConfigMap                         redis-health                      create
 +      ├─ kubernetes:apps:StatefulSet                       redis-master                      create
 +      └─ kubernetes:extensions:Deployment                  redis-slave                       create

info: 9 changes previewed:
    + 9 resources to create</code></pre></figure>

<p>As you can see, we’re generating the resources automatically because Pulumi renders the helm chart for us, and then creates the resources, which really is very awesome.</p>

<p>However, it gets more awesome when you see there’s a callback called <code class="language-plaintext highlighter-rouge">transformations</code>. This allows you to patch and manipulate the generated resources! For example:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">k8s</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@pulumi/kubernetes</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">helm</span><span class="p">.</span><span class="nx">v2</span><span class="p">.</span><span class="nx">Chart</span><span class="p">(</span><span class="dl">"</span><span class="s2">redis</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">repo</span><span class="p">:</span> <span class="dl">"</span><span class="s2">stable</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">chart</span><span class="p">:</span> <span class="dl">"</span><span class="s2">redis</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">version</span><span class="p">:</span> <span class="dl">"</span><span class="s2">3.10.0</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">values</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">usePassword</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">rbac</span><span class="p">:</span> <span class="p">{</span> <span class="na">create</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="p">},</span>
    <span class="na">transformations</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">// Make every service private to the cluster, i.e., turn all services into ClusterIP instead of</span>
        <span class="c1">// LoadBalancer.</span>
        <span class="p">(</span><span class="na">obj</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">kind</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">Service</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">apiVersion</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">v1</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">spec</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="kd">type</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="kd">type</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">LoadBalancer</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">obj</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="kd">type</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">ClusterIP</span><span class="dl">"</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">});</span></code></pre></figure>

<p>Of course, you can combine this with the configuration options from before as well, so you can override these as needed.</p>

<p>I think it’s worth emphasising that this improves the implementation time for any Kubernetes deployed resource <em>dramatically</em>. Before, if you wanted to use something <em>other</em> than helm to deploy something, you had to write it from scratch. Pulumi’s ability to import and them manipulate rendered helm charts is a massive massive win for the operator and the community!</p>

<h1 id="wrap-up">Wrap up</h1>

<p>I think Pulumi is going to change the way we deploy things to Kubernetes, but it’s also definitely in the running to solve the configuration management problem. Writing resources in code is much much better than writing yaml or even jsonnet, and having the ability to be flexible with your deployments and manifests using the Pulumi concepts is really exciting.</p>

<p>I’ve put the code examples from the blog post in a <a href="https://github.com/jaxxstorm/pulumi-kubernetes-example">github repo</a> for people to look at and improve. I really hope people try out Pulumi!</p>

<br>

<div id="disqus_thread"></div>
<script>


var disqus_config = function () {
this.page.url = 'http://localhost:4000/assets/style.css';
this.page.identifier = '/blog/2018/09/20/using-pulumi-for-k8s-config-mgmt.html'; 
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

<br>
<div class="about">
<div class="about__devider">*****</div>
<div class="about__text">
<br>
&#169 2021, Lee Briggs | <a href="https://github.com/ritijjain/pudhina-fresh">Pudhina Fresh</a> theme for Jekyll.
</div>
</div>

</div>
</body>
</html>