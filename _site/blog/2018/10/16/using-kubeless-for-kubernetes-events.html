<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Using Kubeless for Kubernetes Events | lbr.</title>

<meta name="description" content="Engineering, DevOps & Cloud Computing
">
<meta name="keywords" content="kubernetes, serverless, kubeless">
<link rel="canonical" href="/blog/2018/10/16/using-kubeless-for-kubernetes-events.html">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34865189-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34865189-1');
</script>


<!--Feature assets-->
<!--Bootstrap JS-->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<!--Font Awesome-->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

<!--Highlight.js-->
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!--Main assets-->
<link rel="icon" type="image/jpeg" href="/favicon.png"/>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
<div class="wrapper">
<header class="header">
<div class="navigation">

<a href="/" class="logo">lbr.</a>

<ul class="menu">
<li class="menu__entry"><a href="/">about</a></li>
<li class="menu__entry"><a href="/projects">projects</a></li>
<li class="menu__entry"><a href="/blog">blog</a></li>
</ul>
</div>
<ul class="social-links">

<a href="mailto:/contact@leebriggs.co.uk" class="social-links__entry" target="_blank">
<i class="fas fa-envelope-square"></i>
</a>


<a href="https://github.com//jaxxstorm" class="social-links__entry" target="_blank">
<i class="fab fa-github"></i>
</a>


<a href="https://linkedin.com/in//briggsl" class="social-links__entry" target="_blank">
<i class="fab fa-linkedin-in"></i>
</a>

</ul>
</header>

<br>
<br>
<h1 class="post-title">
    <div class="post-title__text">Using Kubeless for Kubernetes Events</div>
</h1>
<p class="post-title__subtitle">Published Oct 16, 2018  by <a href="https://leebriggs.co.uk/">Lee Briggs<a><br />


    <span class="badge badge-info">#kubernetes</span>

    <span class="badge badge-info">#serverless</span>

    <span class="badge badge-info">#kubeless</span>

<hr>
<br>
<p>Serverless computing is all the rage at the moment, and why wouldn’t it be? The idea of deploying code without having to worry about anything like servers, or that pesky infrastructure everyone complains about seems pretty appealing. If you’ve ever used AWS lamdba or one of its related cousins, you’ll be able to see the freedom that triggering functions on events brings you.</p>

<p>The increase in excitement around serverless frameworks means that naturally, there’s been an increase in providers in the Kubernetes world. A quick look at the <a href="https://landscape.cncf.io/landscape=serverless">CNCF Landscape page</a> shows just how many options there are to Kubernetes cluster operators.</p>

<p>In this post I wanted to look at <a href="https://kubeless.io">Kubeless</a>, a serverless framework written by the awesome people at <a href="https://bitnami.com/">Bitnami</a>.</p>

<p>Kubeless appealed to me specifically for a few reasons:</p>

<ul>
  <li>Native Kubernetes resources (<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRDs</a>) for functions, meaning that standard Kubernetes deployment constructs can be used</li>
  <li>No external dependencies to get started</li>
  <li>Support for PubSub functions without having to manually bind to messages queues etc</li>
  <li>Lots of language support with the runtimes</li>
</ul>

<p>Before you get started with this, you’ll probably want to follow the <a href="https://kubeless.io/docs/quick-start/">Quick Start</a> as well as get an understanding of how the <a href="https://kubeless.io/docs/pubsub-functions/">PubSub</a> functions work.</p>

<p>To follow along here you’ll need:</p>

<ul>
  <li>A working kubeless deployment, including the kubeless cli</li>
  <li>A working NATS cluster, perhaps using the <a href="https://github.com/nats-io/nats-operator">NATS Operator</a>.</li>
  <li>You’ll also need the as the <a href="https://github.com/kubeless/nats-trigger">Kubeless NATS Trigger</a> installed in your cluster.</li>
</ul>

<p>In this walkthrough, I wanted to show you how easy it is to get Kubernetes events (in this case, pod creations) and then use kubeless to perform actions on them (like post to a slack channel).</p>

<p><em>I’m aware there are tools out there that already fulfill this function (ie events to slack) but I figured it was a good showcase of what can be done!</em></p>

<h1 id="publishing-kubernetes-events">Publishing Kubernetes Events</h1>

<p>Before you can trigger kubeless functions, you first need to have events from Kubernetes published to your NATS cluster.</p>

<p>To do this, I used the excellent <a href="https://github.com/kubernetes-client/python">kubernetes python library</a></p>

<p>An easy way to do this is simply connect to the API using the in_cluster capabilities and then list all the pods, like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">kubernetes</span> <span class="kn">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">watch</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="c1"># use your machines kubeconfig
</span>  <span class="n">config</span><span class="p">.</span><span class="n">load_kube_config</span><span class="p">()</span>

  <span class="n">v1</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">CoreV1Api</span><span class="p">()</span>

  <span class="n">w</span> <span class="o">=</span> <span class="n">watch</span><span class="p">.</span><span class="n">Watch</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">w</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">list_pod_for_all_namespaces</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Event: %s %s %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">'type'</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s">'object'</span><span class="p">].</span><span class="n">kind</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s">'object'</span><span class="p">].</span><span class="n">metadata</span><span class="p">.</span><span class="n">name</span><span class="p">))</span>


<span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>This simple script will log all the information for pods in all namespaces to stdout. It can be run on your local machine, give it a try!</p>

<p>The problem with this is that it’s just spitting information to stdout to test locally, so we need to publish this events to NATS. In order to do this, we’ll use the <a href="https://github.com/nats-io/asyncio-nats">python aysncio-nats libarary</a></p>

<p>Now, your script has gotten much more complicated:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">kubernetes</span> <span class="kn">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">watch</span>

<span class="kn">from</span> <span class="nn">nats.aio.client</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">NATS</span>
<span class="kn">from</span> <span class="nn">nats.aio.errors</span> <span class="kn">import</span> <span class="n">ErrConnectionClosed</span><span class="p">,</span> <span class="n">ErrTimeout</span><span class="p">,</span> <span class="n">ErrNoServers</span>

<span class="c1"># connect to the cluster defined in $KUBECONFIG
</span><span class="n">config</span><span class="p">.</span><span class="n">load_kube_config</span><span class="p">()</span>

<span class="c1"># set up the kubernetes core API
</span><span class="n">v1</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">CoreV1Api</span><span class="p">()</span>

<span class="c1"># created a method that runs async
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="c1"># set up NATS connection
</span>    <span class="n">nc</span> <span class="o">=</span> <span class="n">NATS</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># connect to a NATS cluster on localhost
</span>        <span class="k">await</span> <span class="n">nc</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'localhost:4222'</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c1"># method to get pod events async
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_pod_events</span><span class="p">():</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">watch</span><span class="p">.</span><span class="n">Watch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">w</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">list_pod_for_all_namespaces</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Event: %s %s %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">'type'</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s">'object'</span><span class="p">].</span><span class="n">kind</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s">'object'</span><span class="p">].</span><span class="n">metadata</span><span class="p">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span><span class="n">event</span><span class="p">[</span><span class="s">'type'</span><span class="p">],</span><span class="s">'object'</span><span class="p">:</span><span class="n">event</span><span class="p">[</span><span class="s">'raw_object'</span><span class="p">]}</span>

            <span class="c1"># publish the events to a NATS topic k8s_events
</span>            <span class="k">await</span> <span class="n">nc</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">"k8s_events"</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># run the method
</span>    <span class="k">await</span> <span class="n">get_pod_events</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">nc</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="c1"># set up the async loop
</span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">run</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># run until killed
</span>        <span class="n">loop</span><span class="p">.</span><span class="n">run_forever</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Event: %s %s %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">'type'</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s">'object'</span><span class="p">].</span><span class="n">kind</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s">'object'</span><span class="p">].</span><span class="n">metadata</span><span class="p">.</span><span class="n">name</span><span class="p">))</span>    
    <span class="c1"># if killed by keyboard shutdown, clean up nicely
</span>    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'keyboard shutdown'</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">.</span><span class="n">all_tasks</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">),</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">tasks</span><span class="p">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">loop</span><span class="p">.</span><span class="n">stop</span><span class="p">())</span>
        <span class="n">tasks</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="c1"># Keep the event loop running until it is either destroyed or all
</span>        <span class="c1"># tasks have really terminated
</span>        <span class="k">while</span> <span class="ow">not</span> <span class="n">tasks</span><span class="p">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="n">loop</span><span class="p">.</span><span class="n">run_forever</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'closing event loop'</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>Okay, so now we have events being pushed to NATS. We need to fancy this up a bit, to allow for running in and out of cluster, as well as building a Docker image. The final script can be found <a href="https://github.com/jaxxstorm/kubeless-events-example/blob/master/events/main.py">here</a>. The changes are to include a logger module, as well as argparse to allow for running in and out of the cluster, as well as make some options configurable.</p>

<p>You should now deploy this to your cluster using the provided <a href="https://github.com/jaxxstorm/kubeless-events-example/blob/master/manifests/events.yaml">deployment manifests</a>, which also include the (rather permissive!) RBAC configuration needed for the deployment to be able to read pod information from the API.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/jaxxstorm/kubeless-events-example/master/manifests/events.yaml</code></pre></figure>

<p>This will install the built docker container to publish events to the NATS cluster configured earlier. If you need to, modify the environment variable <code class="language-plaintext highlighter-rouge">NATS_CLUSTER</code> if you deployed your NATS cluster to another address.</p>

<h1 id="consuming-events-with-kubeless-functions">Consuming Events with Kubeless functions</h1>

<p>So now the events are being published, we need to actually <em>do</em> something with them. Let’s first make sure the events are coming in.</p>

<p>You should have the kubeless cli downloaded by now, so let’s create a quick example function to make sure the events are being posted.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></code></pre></figure>

<p>As you can probably tell, this function just dumps any event sent to it and returns. So let’s try it out. With kubeless, let’s deploy it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubeless <span class="k">function </span>deploy <span class="nb">test</span> <span class="nt">--runtime</span> python3.6 <span class="nt">--handler</span> test.dump <span class="nt">--from-file</span> functions/test.py <span class="nt">-n</span> kubeless</code></pre></figure>

<p>What’s happening here, exactly?</p>

<ul>
  <li>runtime: specify a runtime for the function, in this case, python 3.6</li>
  <li>from-file: path to your file containing your function</li>
  <li>handler: this is the important part. A handler is the kubeless function to call when an event is received. It’s in the format <code class="language-plaintext highlighter-rouge">&lt;filename&gt;</code>.<code class="language-plaintext highlighter-rouge">&lt;functionname&gt;</code>. So in our case, our file was called <code class="language-plaintext highlighter-rouge">test.py</code> and our function was called <code class="language-plaintext highlighter-rouge">dump</code>, so we specify <code class="language-plaintext highlighter-rouge">test.dump</code>.</li>
  <li>namespace: make sure you specify the namespace you deployed kubeless to!</li>
</ul>

<p>So you should now have a function deployed:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">kubeless</span> <span class="n">function</span> <span class="n">ls</span> <span class="o">-</span><span class="n">n</span> <span class="n">kubeless</span>
<span class="n">NAME</span>	<span class="n">NAMESPACE</span>	<span class="n">HANDLER</span>  	<span class="n">RUNTIME</span>  	<span class="n">DEPENDENCIES</span>	<span class="n">STATUS</span>
<span class="n">test</span>	<span class="n">kubeless</span> 	<span class="n">test</span><span class="p">.</span><span class="n">dump</span>	<span class="n">python3</span><span class="p">.</span><span class="mi">6</span>	            	<span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="n">READY</span></code></pre></figure>

<p>So now, we need to have this function be triggered by the NATS messages. To do that, we add a trigger:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">kubeless</span> <span class="n">trigger</span> <span class="n">nats</span> <span class="n">create</span> <span class="n">test</span> <span class="o">--</span><span class="n">function</span><span class="o">-</span><span class="n">selector</span> <span class="n">created</span><span class="o">-</span><span class="n">by</span><span class="o">=</span><span class="n">kubeless</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">test</span> <span class="o">--</span><span class="n">trigger</span><span class="o">-</span><span class="n">topic</span> <span class="n">k8s_events</span> <span class="o">-</span><span class="n">n</span> <span class="n">kubeless</span></code></pre></figure>

<p>What’s going on here?</p>

<ul>
  <li>We create a trigger with <code class="language-plaintext highlighter-rouge">name</code> test</li>
  <li><code class="language-plaintext highlighter-rouge">function-selector</code>: use labels created by kubeless function to select the function to run</li>
  <li><code class="language-plaintext highlighter-rouge">trigger-topic</code>: specify a trigger topic of k8s_events (which is specified in the event publisher from earlier)</li>
  <li>Same namespace!</li>
</ul>

<p>Okay, so now, let’s cycle the event publisher and test things out!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># delete the current nats event pods
# this will readd all the pods and republish them
</span><span class="n">kubectl</span> <span class="n">delete</span> <span class="n">po</span> <span class="o">-</span><span class="n">l</span> <span class="n">app</span><span class="o">=</span><span class="n">kubeless</span><span class="o">-</span><span class="n">nats</span><span class="o">-</span><span class="n">events</span> <span class="o">-</span><span class="n">n</span> <span class="n">kubeless</span>

<span class="c1"># read the pod logs from the kubeless function we created
</span><span class="n">k</span> <span class="n">logs</span> <span class="o">-</span><span class="n">l</span> <span class="n">function</span><span class="o">=</span><span class="n">test</span> <span class="o">-</span><span class="n">n</span> <span class="n">kubeless</span></code></pre></figure>

<p>You should see something like this as an output log:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">{</span><span class="s1">'data'</span>: <span class="o">{</span><span class="s1">'type'</span>: <span class="s1">'MODIFIED'</span>, <span class="s1">'object'</span>: <span class="o">{</span><span class="s1">'kind'</span>: <span class="s1">'Pod'</span>, <span class="s1">'apiVersion'</span>: <span class="s1">'v1'</span>, <span class="s1">'metadata'</span>: <span class="o">{</span><span class="s1">'name'</span>: <span class="s1">'nats-trigger-controller-66df75894b-mxppc'</span>, <span class="s1">'generateName'</span>: <span class="s1">'nats-trigger-controller-66df75894b-'</span>, <span class="s1">'namespace'</span>: <span class="s1">'kubeless'</span>, <span class="s1">'selfLink'</span>: <span class="s1">'/api/v1/namespaces/kubeless/pods/nats-trigger-controller-66df75894b-mxppc'</span>, <span class="s1">'uid'</span>: <span class="s1">'01ead80a-d0ef-11e8-8e5f-42010aa80fc2'</span>, <span class="s1">'resourceVersion'</span>: <span class="s1">'16046597'</span>, <span class="s1">'creationTimestamp'</span>: <span class="s1">'2018-10-16T02:55:58Z'</span>, <span class="s1">'labels'</span>: <span class="o">{</span><span class="s1">'kubeless'</span>: <span class="s1">'nats-trigger-controller'</span>, <span class="s1">'pod-template-hash'</span>: <span class="s1">'2289314506'</span><span class="o">}</span>, <span class="s1">'ownerReferences'</span>: <span class="o">[{</span><span class="s1">'apiVersion'</span>: <span class="s1">'extensions/v1beta1'</span>, <span class="s1">'kind'</span>: <span class="s1">'ReplicaSet'</span>, <span class="s1">'name'</span>: <span class="s1">'nats-trigger-controller-66df75894b'</span>, <span class="s1">'uid'</span>: <span class="s1">'01e65ec2-d0ef-11e8-8e5f-42010aa80fc2'</span>, <span class="s1">'controller'</span>: True, <span class="s1">'blockOwnerDeletion'</span>: True<span class="o">}]}</span>, <span class="s1">'spec'</span>: <span class="o">{</span><span class="s1">'volumes'</span>: <span class="o">[{</span><span class="s1">'name'</span>: <span class="s1">'controller-acct-token-dwfj5'</span>, <span class="s1">'secret'</span>: <span class="o">{</span><span class="s1">'secretName'</span>: <span class="s1">'controller-acct-token-dwfj5'</span>, <span class="s1">'defaultMode'</span>: 420<span class="o">}}]</span>, <span class="s1">'containers'</span>: <span class="o">[{</span><span class="s1">'name'</span>: <span class="s1">'nats-trigger-controller'</span>, <span class="s1">'image'</span>: <span class="s1">'bitnami/nats-trigger-controller:v1.0.0-alpha.9'</span>, <span class="s1">'env'</span>: <span class="o">[{</span><span class="s1">'name'</span>: <span class="s1">'KUBELESS_NAMESPACE'</span>, <span class="s1">'valueFrom'</span>: <span class="o">{</span><span class="s1">'fieldRef'</span>: <span class="o">{</span><span class="s1">'apiVersion'</span>: <span class="s1">'v1'</span>, <span class="s1">'fieldPath'</span>: <span class="s1">'metadata.namespace'</span><span class="o">}}}</span>, <span class="o">{</span><span class="s1">'name'</span>: <span class="s1">'KUBELESS_CONFIG'</span>, <span class="s1">'value'</span>: <span class="s1">'kubeless-config'</span><span class="o">}</span>, <span class="o">{</span><span class="s1">'name'</span>: <span class="s1">'NATS_URL'</span>, <span class="s1">'value'</span>: <span class="s1">'nats://nats-cluster.nats-io.svc.cluster.local:4222'</span><span class="o">}]</span>, <span class="s1">'resources'</span>: <span class="o">{}</span>, <span class="s1">'volumeMounts'</span>: <span class="o">[{</span><span class="s1">'name'</span>: <span class="s1">'controller-acct-token-dwfj5'</span>, <span class="s1">'readOnly'</span>: True, <span class="s1">'mountPath'</span>: <span class="s1">'/var/run/secrets/kubernetes.io/serviceaccount'</span><span class="o">}]</span>, <span class="s1">'terminationMessagePath'</span>: <span class="s1">'/dev/termination-log'</span>, <span class="s1">'terminationMessagePolicy'</span>: <span class="s1">'File'</span>, <span class="s1">'imagePullPolicy'</span>: <span class="s1">'IfNotPresent'</span><span class="o">}]</span>, <span class="s1">'restartPolicy'</span>: <span class="s1">'Always'</span>, <span class="s1">'terminationGracePeriodSeconds'</span>: 30, <span class="s1">'dnsPolicy'</span>: <span class="s1">'ClusterFirst'</span>, <span class="s1">'serviceAccountName'</span>: <span class="s1">'controller-acct'</span>, <span class="s1">'serviceAccount'</span>: <span class="s1">'controller-acct'</span>, <span class="s1">'nodeName'</span>: <span class="s1">'gke-lbr-default-pool-3071fe55-kfm6'</span>, <span class="s1">'securityContext'</span>: <span class="o">{}</span>, <span class="s1">'schedulerName'</span>: <span class="s1">'default-scheduler'</span>, <span class="s1">'tolerations'</span>: <span class="o">[{</span><span class="s1">'key'</span>: <span class="s1">'node.kubernetes.io/not-ready'</span>, <span class="s1">'operator'</span>: <span class="s1">'Exists'</span>, <span class="s1">'effect'</span>: <span class="s1">'NoExecute'</span>, <span class="s1">'tolerationSeconds'</span>: 300<span class="o">}</span>, <span class="o">{</span><span class="s1">'key'</span>: <span class="s1">'node.kubernetes.io/unreachable'</span>, <span class="s1">'operator'</span>: <span class="s1">'Exists'</span>, <span class="s1">'effect'</span>: <span class="s1">'NoExecute'</span>, <span class="s1">'tolerationSeconds'</span>: 300<span class="o">}]}</span>, <span class="s1">'status'</span>: <span class="o">{</span><span class="s1">'phase'</span>: <span class="s1">'Running'</span>, <span class="s1">'conditions'</span>: <span class="o">[{</span><span class="s1">'type'</span>: <span class="s1">'Initialized'</span>, <span class="s1">'status'</span>: <span class="s1">'True'</span>, <span class="s1">'lastProbeTime'</span>: None, <span class="s1">'lastTransitionTime'</span>: <span class="s1">'2018-10-16T02:55:58Z'</span><span class="o">}</span>, <span class="o">{</span><span class="s1">'type'</span>: <span class="s1">'Ready'</span>, <span class="s1">'status'</span>: <span class="s1">'True'</span>, <span class="s1">'lastProbeTime'</span>: None, <span class="s1">'lastTransitionTime'</span>: <span class="s1">'2018-10-16T02:56:00Z'</span><span class="o">}</span>, <span class="o">{</span><span class="s1">'type'</span>: <span class="s1">'PodScheduled'</span>, <span class="s1">'status'</span>: <span class="s1">'True'</span>, <span class="s1">'lastProbeTime'</span>: None, <span class="s1">'lastTransitionTime'</span>: <span class="s1">'2018-10-16T02:55:58Z'</span><span class="o">}]</span>, <span class="s1">'hostIP'</span>: <span class="s1">'10.168.0.5'</span>, <span class="s1">'podIP'</span>: <span class="s1">'10.36.14.29'</span>, <span class="s1">'startTime'</span>: <span class="s1">'2018-10-16T02:55:58Z'</span>, <span class="s1">'containerStatuses'</span>: <span class="o">[{</span><span class="s1">'name'</span>: <span class="s1">'nats-trigger-controller'</span>, <span class="s1">'state'</span>: <span class="o">{</span><span class="s1">'running'</span>: <span class="o">{</span><span class="s1">'startedAt'</span>: <span class="s1">'2018-10-16T02:55:59Z'</span><span class="o">}}</span>, <span class="s1">'lastState'</span>: <span class="o">{}</span>, <span class="s1">'ready'</span>: True, <span class="s1">'restartCount'</span>: 0, <span class="s1">'image'</span>: <span class="s1">'bitnami/nats-trigger-controller:v1.0.0-alpha.9'</span>, <span class="s1">'imageID'</span>: <span class="s1">'docker-pullable://bitnami/nats-trigger-controller@sha256:d04c8141d12838732bdb33b2890eb00e5639c243e33d4ebdad34d2e065c54357'</span>, <span class="s1">'containerID'</span>: <span class="s1">'docker://d9ff52fa7e5d821c12fd910e85776e2a422098cde37a7f2c8054e7457f41aa1e'</span><span class="o">}]</span>, <span class="s1">'qosClass'</span>: <span class="s1">'BestEffort'</span><span class="o">}}}</span>, <span class="s1">'event-id'</span>: <span class="s1">'YMAok3se6ZQyMTM'</span>, <span class="s1">'event-type'</span>: <span class="s1">'application/json'</span>, <span class="s1">'event-time'</span>: <span class="s1">'2018-10-16 02:56:00.738120124 +0000 UTC'</span>, <span class="s1">'event-namespace'</span>: <span class="s1">'natstriggers.kubeless.io'</span>, <span class="s1">'extensions'</span>: <span class="o">{</span><span class="s1">'request'</span>: &lt;LocalRequest: POST http://test.kubeless.svc.cluster.local:8080/&gt;<span class="o">}}</span></code></pre></figure>

<p>This is the modification event for the pod you just cycled. Awesome!</p>

<h1 id="publish-the-event-to-slack">Publish the event to slack</h1>

<p>Okay, so now you’ve got some events being shipped, it’s time to get a little bit more creative. Let’s publish some of these events to slack.</p>

<p>You can create a <code class="language-plaintext highlighter-rouge">slack.py</code> with your function in, like so:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python
</span><span class="kn">from</span> <span class="nn">slackclient</span> <span class="kn">import</span> <span class="n">SlackClient</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">slack_message</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Grab the slack token and channel from the environment vars
</span>        <span class="n">slack_token</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'SLACK_TOKEN'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">slack_channel</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'SLACK_CHANNEL'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">slack_token</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">'No slack token set, can</span><span class="se">\'</span><span class="s">t do anything'</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># post a slack message!
</span>            <span class="n">sc</span> <span class="o">=</span> <span class="n">SlackClient</span><span class="p">(</span><span class="n">slack_token</span><span class="p">)</span>
            <span class="n">sc</span><span class="p">.</span><span class="n">api_call</span><span class="p">(</span>
                <span class="s">"chat.postMessage"</span><span class="p">,</span>
                <span class="n">channel</span><span class="o">=</span><span class="n">slack_channel</span><span class="p">,</span>
                <span class="n">attachments</span><span class="o">=</span><span class="p">[</span> <span class="p">{</span> <span class="s">"title"</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span><span class="o">+</span><span class="s">" Pod event"</span><span class="p">,</span> <span class="s">"text"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>  <span class="p">}</span> <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">inst</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">))</span></code></pre></figure>

<p>You’ll need to deploy your function using the kubeless binary:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">export </span><span class="nv">SLACK_TOKEN</span><span class="o">=</span>&lt;my_slack_token&gt;
<span class="nb">export </span><span class="nv">SLACK_CHANNEL</span><span class="o">=</span>&lt;my_slack_channel&gt;

kubeless <span class="k">function </span>deploy slack <span class="nt">--runtime</span> python3.6 <span class="nt">--handler</span> slack.slack_message <span class="nt">--from-file</span> slack.py <span class="nt">-n</span> kubeless <span class="nt">--env</span> <span class="nv">SLACK_TOKEN</span><span class="o">=</span><span class="nv">$SLACK_TOKEN</span> <span class="nt">--env</span> <span class="nv">SLACK_CHANNEL</span><span class="o">=</span><span class="nv">$SLACK_CHANNEL</span> <span class="nt">--dependencies</span> requirements.txt</code></pre></figure>

<p>The only thing you might be confused about here is the <code class="language-plaintext highlighter-rouge">--dependencies</code> file. Kubeless uses this to determine which dependencies you need to install for the function runtime. In the python case, it’s a requirements.txt. You can find a working one in the related <a href="https://github.com/jaxxstorm/kubeless-events-example/blob/master/functions/slack.py">github repo</a> linked to this post. This example better formats the slack responses into nice slack output, so it’s worth taking a look at.</p>

<p>You’ll obviously need a slack org to try this out, and need to generate a slack token to get API access. However, now, once you cycle the events pod again (or, run another pod of course!) - you’ll now see these events pushed to slack!</p>

<p><img src="https://i.imgur.com/33lEhUq.png" alt="slack-events" class="img-responsive" /></p>

<h1 id="wrap-up">Wrap up</h1>

<p>Obviously this is a trivial example of using these functions, but the power of the event pipeline with kubeless is there to be seen. Anything you might need to happy when certain events happen in your Kubernetes cluster can be automated using this Kubeless event pipeline.</p>

<p>You can check out all the code, deployment and manifests for this post in the <a href="https://github.com/jaxxstorm/kubeless-events-example">github repo</a> that accompanies this post. Pull requests and feedback on my awful Python code are also welcome!</p>

<br>

<div id="disqus_thread"></div>
<script>


var disqus_config = function () {
this.page.url = 'https://leebriggs.co.uk/assets/style.css';
this.page.identifier = '/blog/2018/10/16/using-kubeless-for-kubernetes-events.html'; 
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

<br>
<div class="about">
<div class="about__devider">*****</div>
<div class="about__text">
<br>
&#169 2021, Lee Briggs | <a href="https://github.com/ritijjain/pudhina-fresh">Pudhina Fresh</a> theme for Jekyll.
</div>
</div>

</div>
</body>
</html>