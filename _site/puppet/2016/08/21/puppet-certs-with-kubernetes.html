<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Using Puppet's certificates with Kubernetes | lbr.</title>

<meta name="description" content="Engineering, DevOps & Cloud Computing
">
<meta name="keywords" content="puppet, kubernetes">
<link rel="canonical" href="/puppet/2016/08/21/puppet-certs-with-kubernetes.html">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34865189-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34865189-1');
</script>


<!--Feature assets-->
<!--Bootstrap JS-->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<!--Font Awesome-->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

<!--Highlight.js-->
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.3.2/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!--Main assets-->
<link rel="icon" type="image/jpeg" href="/favicon.png"/>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
<div class="wrapper">
<header class="header">
<div class="navigation">

<a href="/" class="logo">lbr.</a>

<ul class="menu">
<li class="menu__entry"><a href="/">about</a></li>
<li class="menu__entry"><a href="/projects">projects</a></li>
<li class="menu__entry"><a href="/blog">blog</a></li>
</ul>
</div>
<ul class="social-links">

<a href="mailto:/contact@leebriggs.co.uk" class="social-links__entry" target="_blank">
<i class="fas fa-envelope-square"></i>
</a>


<a href="https://github.com//jaxxstorm" class="social-links__entry" target="_blank">
<i class="fab fa-github"></i>
</a>


<a href="https://linkedin.com/in//briggsl" class="social-links__entry" target="_blank">
<i class="fab fa-linkedin-in"></i>
</a>

</ul>
</header>

<br>
<br>
<h1 class="post-title">
    <div class="post-title__text">Using Puppet's certificates with Kubernetes</div>
</h1>
<p class="post-title__subtitle">Published Aug 21, 2016  by <a href="https://leebriggs.co.uk/">Lee Briggs<a><br />


    <span class="badge badge-info">#puppet</span>

    <span class="badge badge-info">#kubernetes</span>

<hr>
<br>
<p>We’re finally beginning to build out our production <a href="http://kubernetes.io/">Kubernetes</a> infrastructure at work, after some extensive testing in dev. Kubernetes relies heavily on TLS for securing communications between all of the components (quite understandably) and while you can disable TLS on many components, obviously once you get to production, you don’t really want to be doing that.</p>

<p>Most of the documentation shows you how to generate a self signed certficate using a CA certificate you create especially for kubernetes. Even <a href="https://twitter.com/kelseyhightower">Kelsey Hightower’s</a> excellent “<a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/README.md">Kubernetes the Hard Way</a>” post shows you how to <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/02-certificate-authority.md">generate the TLS components using a self signed CA</a>. One of the nicest things about using Puppet is that you already <em>have</em> a CA set up and best of all, there’s some really nice APIs inside the puppet master/server meaning provisioning new certs for hosts is relatively straightforward. I really wanted to take advantage of this with our kubernetes setup, so I made sure etcd was using Puppet’s certs:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#[security]</span>
<span class="nv">ETCD_CERT_FILE</span><span class="o">=</span><span class="s2">"/var/lib/puppet/ssl/certs/hostname.server.lan.pem"</span>
<span class="nv">ETCD_KEY_FILE</span><span class="o">=</span><span class="s2">"/var/lib/puppet/ssl/private_keys/hostname.server.lan.pem"</span>
<span class="nv">ETCD_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/var/lib/puppet/ssl/certs/ca.pem"</span>
<span class="nv">ETCD_PEER_CERT_FILE</span><span class="o">=</span><span class="s2">"/var/lib/puppet/ssl/certs/hostname.server.lan.pem"</span>
<span class="nv">ETCD_PEER_KEY_FILE</span><span class="o">=</span><span class="s2">"/var/lib/puppet/ssl/private_keys/hostname.server.lan.pem"</span>
<span class="nv">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="nb">true
</span><span class="nv">ETCD_PEER_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/var/lib/puppet/ssl/certs/ca.pem"</span></code></pre></figure>

<p>This works out of the box, because the certs for all 3 etcd hosts have been signed by the same CA.</p>

<h2 id="securing-kubernetes-with-puppets-certs">Securing Kubernetes with Puppet’s Certs.</h2>

<p>I figured it would be easy to use these certs for Kubernetes also. I set the following parameters in the API server config:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nt">--service-account-key-file</span><span class="o">=</span>/var/lib/puppet/ssl/private_keys/hostname.server.lan.pem <span class="nt">--tls-cert-file</span><span class="o">=</span>/var/lib/puppet/ssl/certs/hostname.server.lan.pem <span class="nt">--tls-private-key-file</span><span class="o">=</span>/var/lib/puppet/ssl/private_keys/hostname.server.lan.pem</code></pre></figure>

<p>but there were a multitude of problems, the main one being that when a pod starts up, it connects to the API using the kubernetes service cluster IP. You can see this in the log messages when starting a pod:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># kubectl logs kube-dns-v15-017ri --namespace=kube-system kubedns</span>
I0821 08:48:12.808230       1 server.go:91] Using https://10.254.0.1:443 <span class="k">for </span>kubernetes master
I0821 08:48:12.808304       1 server.go:92] Using kubernetes API &lt;nil&gt;
I0821 08:48:12.809448       1 server.go:132] Starting SkyDNS server. Listening on port:10053</code></pre></figure>

<p>I figured it would be easy enough to fix, I’ll just add a SAN for the puppet cert using the <a href="https://docs.puppet.com/puppet/latest/reference/configuration.html#dnsaltnames">dns_alt_names</a> configuration option. Unfortunately, this didn’t work, and I got the following error message:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">E1125 17:33:16.308389 1 errors.go:62] Status: x509: cannot validate certificate because it doesn<span class="s1">'t contain any IP SANs</span></code></pre></figure>

<p>Puppet doesn’t have an option to set IP SANS in the SSL certificate, so I had to generate the cert manually and sign it by the Puppet CA. Thankfully, this is fairly straightforward (albeit manual)</p>

<h2 id="generating-certs-manually">Generating Certs Manually</h2>

<p>First, create a Kubernetes config file for OpenSSL on your puppetmaster. I created a directory /var/lib/puppet/ssl/manual_ca to do all this.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span> ca <span class="o">]</span>

default_ca      <span class="o">=</span> CA_default

<span class="o">[</span> CA_default <span class="o">]</span>

<span class="nb">dir</span>            <span class="o">=</span> /var/lib/puppet/ssl/manual_ca
certs          <span class="o">=</span> <span class="nv">$dir</span>/certs
crl_dir        <span class="o">=</span> <span class="nv">$dir</span>/crl
database       <span class="o">=</span> <span class="nv">$dir</span>/index.txt
new_certs_dir  <span class="o">=</span> <span class="nv">$dir</span>/newcerts
certificate    <span class="o">=</span> /var/lib/puppet/ssl/ca/ca_crt.pem
serial         <span class="o">=</span> <span class="nv">$dir</span>/serial
crl            <span class="o">=</span> /var/lib/puppet/ssl/ca/ca_crl.pem
private_key    <span class="o">=</span> /var/lib/puppet/ssl/ca/ca_key.pem
RANDFILE       <span class="o">=</span> <span class="nv">$dir</span>/ca/.rand
default_md     <span class="o">=</span> sha256
policy         <span class="o">=</span> policy_any
unique_subject <span class="o">=</span> no

<span class="o">[</span> policy_any <span class="o">]</span>
countryName            <span class="o">=</span> supplied
stateOrProvinceName    <span class="o">=</span> optional
organizationName       <span class="o">=</span> optional
organizationalUnitName <span class="o">=</span> optional
commonName             <span class="o">=</span> supplied
emailAddress           <span class="o">=</span> optional

<span class="o">[</span>req]
req_extensions <span class="o">=</span> v3_req
distinguished_name <span class="o">=</span> req_distinguished_name
string_mask             <span class="o">=</span> utf8only

<span class="o">[</span> req_distinguished_name <span class="o">]</span>
countryName             <span class="o">=</span> Country
stateOrProvinceName     <span class="o">=</span> State
localityName            <span class="o">=</span> Locality
organizationName        <span class="o">=</span> Org
organizationalUnitName  <span class="o">=</span> Me
commonName              <span class="o">=</span> <span class="nb">hostname</span>

<span class="o">[</span> v3_req <span class="o">]</span>
keyUsage <span class="o">=</span> nonRepudiation, digitalSignature, keyEncipherment
subjectAltName <span class="o">=</span> @alt_names

<span class="o">[</span>alt_names]
DNS.1 <span class="o">=</span> kubernetes
DNS.2 <span class="o">=</span> kubernetes.default
DNS.3 <span class="o">=</span> kubernetes.default.svc
DNS.4 <span class="o">=</span> kubernetes.default.svc.cluster.local
DNS.5 <span class="o">=</span> kubernetes.service.discover
DNS.6 <span class="o">=</span> <span class="nb">hostname
</span>IP.1 <span class="o">=</span> 10.254.0.1
IP.2 <span class="o">=</span> 192.168.4.10 <span class="c"># external IP</span></code></pre></figure>

<p>Note the two IPs here. The first is the cluster IP from the kubernetes service, you can retrieve it like so:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># kubectl get svc</span>
NAME           CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
kubernetes     10.254.0.1       &lt;none&gt;        443/TCP    21d</code></pre></figure>

<p>I also added the actual IP of the kubernetes host for some future proofing. The DNS names have been generated from the Kube DNS config, so also make sure you match that to your kube-dns name.</p>

<p>Next, we need to generate a CSR and a key:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">openssl req <span class="nt">-newkey</span> rsa:2048 <span class="nt">-nodes</span> <span class="nt">-keyout</span> private_keys/kube-api.key <span class="nt">-out</span> certificate_requests/kube-api.csr <span class="nt">-config</span> kubernetes.cnf</code></pre></figure>

<p>Verify that your CSR has the IP SANS in it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">openssl req <span class="nt">-text</span> <span class="nt">-noout</span> <span class="nt">-verify</span> <span class="nt">-in</span> certificate_requests/kube-api.csr | <span class="nb">grep</span> <span class="s2">"X509v3 Subject"</span> <span class="nt">-A</span> 1</code></pre></figure>

<p>Now, we need to sign the cert with the Puppet CA:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> certificate_requests/kube-api.csr <span class="nt">-CA</span> /var/lib/puppet/ssl/ca/ca_crt.pem <span class="nt">-CAkey</span> /var/lib/puppet/ssl/ca/ca_key.pem <span class="nt">-CAcreateserial</span> <span class="nt">-out</span> certs/kube-api.pem <span class="nt">-days</span> 3000 <span class="nt">-extensions</span> v3_req <span class="nt">-extfile</span> kubernetes.cnf</code></pre></figure>

<p>This will create a cert in certs/kube-api.pem. Now verify it to ensure it looks okay:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">openssl x509 <span class="nt">-in</span> certs/kube-api.pem <span class="nt">-text</span> <span class="nt">-noout</span></code></pre></figure>

<p>We now have the a cert we can use for our kube-apiserver, so we just need to configure kubernetes to use it.</p>

<h2 id="configuring-kubernetes-to-use-the-certs">Configuring Kubernetes to use the certs.</h2>

<p>Assuming you’ve copied the certs to your kubernetes master, we now need to configure k8s to use it. First, make sure you have the following config set in the apiserver:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nt">--service-account-key-file</span><span class="o">=</span>/etc/kubernetes/kube-api.key <span class="nt">--tls-cert-file</span><span class="o">=</span>/etc/kubernetes/kube-api.pem <span class="nt">--tls-private-key-file</span><span class="o">=</span>/etc/kubernetes/kube-api.key</code></pre></figure>

<p>And then configure the controller manager like so:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nt">--root-ca-file</span><span class="o">=</span>/var/lib/puppet/ssl/certs/ca.pem <span class="nt">--service-account-private-key-file</span><span class="o">=</span>/etc/kubernetes/kube-api.key</code></pre></figure>

<p>Restart all the k8s components, and you’re almost set.</p>

<h2 id="regenerate-service-account-secrets">Regenerate service account secrets</h2>

<p>The final thing you’ll need to do is delete the service account secrets kubernetes generates on launch. The reason for this is because it use the service-account-private-key-file to generate them, and if you don’t do this you’ll get all manner of permission denied errors when launching pods. It’s easy to do this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl delete sa default
kubectl delete sa default <span class="nt">--namespace</span><span class="o">=</span>kube-system</code></pre></figure>

<p><em>NOTE</em> if you’re already running pods in your kubernetes system, this may affect them and you may want to be careful doing this. YMMV.</p>

<p>From here, you’re using Puppet’s SSL Certs for kubernetes.</p>


<br>

<div id="disqus_thread"></div>
<script>


var disqus_config = function () {
this.page.url = 'https://leebriggs.co.uk/assets/style.css';
this.page.identifier = '/puppet/2016/08/21/puppet-certs-with-kubernetes.html'; 
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

<br>
<div class="about">
<div class="about__devider">*****</div>
<div class="about__text">
<br>
&#169 2021, Lee Briggs | <a href="https://github.com/ritijjain/pudhina-fresh">Pudhina Fresh</a> theme for Jekyll.
</div>
</div>

</div>
</body>
</html>